{% extends "base.html" %}

{% block title %}Live Road Map - Smart Road Monitor{% endblock %}

{% block extra_css %}
<style>
    /* Map Styles */
    #map {
        height: 600px;
        width: 100%;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        margin-bottom: 1rem;
        background: #e9ecef;
        position: relative;
    }
    
    .map-container {
        position: relative;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 300px;
    }
    
    .route-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 350px;
    }
    
    .marker {
        width: 30px;
        height: 30px;
        border-radius: 50% 50% 50% 0;
        background: var(--accent-red);
        position: absolute;
        transform: rotate(-45deg);
        left: 50%;
        top: 50%;
        margin: -20px 0 0 -20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .marker:after {
        content: '';
        width: 14px;
        height: 14px;
        background: white;
        position: absolute;
        border-radius: 50%;
        top: 8px;
        left: 8px;
    }
    
    .damage-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 100;
    }
    
    .damage-high {
        background-color: var(--accent-red);
        border: 2px solid white;
    }
    
    .damage-medium {
        background-color: var(--accent-yellow);
        border: 2px solid white;
    }
    
    .damage-low {
        background-color: var(--secondary-green);
        border: 2px solid white;
    }
    
    .route-line {
        position: absolute;
        background: transparent;
        pointer-events: none;
        z-index: 50;
    }
    
    .route-point {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary-blue);
        border: 2px solid white;
        position: absolute;
        transform: translate(-50%, -50%);
        cursor: move;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 150;
    }
    
    .route-info {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 300px;
        z-index: 1000;
    }
    
    .damage-popup {
        position: absolute;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 300px;
        z-index: 1001;
        display: none;
    }
    
    .damage-popup h4 {
        margin-top: 0;
        color: var(--primary-dark);
    }
    
    .close-popup {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
    }
    
    .damage-count {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 5px;
    }
    
    .damage-count.high {
        background: var(--accent-red);
        color: white;
    }
    
    .damage-count.medium {
        background: var(--accent-yellow);
        color: var(--dark-text);
    }
    
    .damage-count.low {
        background: var(--secondary-green);
        color: white;
    }
    
    .map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        border-radius: 15px;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--secondary-green);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .suggestions-box {
        position: absolute;
        background: white;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1002;
        display: none;
    }
    
    .suggestion-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .suggestion-item:hover {
        background-color: #f5f5f5;
    }
    
    .map-tooltip {
        position: absolute;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
        z-index: 1003;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero" style="padding: 3rem 0;">
    <div class="container">
        <div class="hero-content">
            <h1>Smart Road Navigator - India</h1>
            <p>Plan your route across India and see road damages along the way. Stay informed, travel safe.</p>
        </div>
    </div>
</section>

<!-- Map Section -->
<section class="section-padding">
    <div class="container">
        <!-- Live Status -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; padding: 10px 15px; background: rgba(42, 157, 143, 0.1); border-radius: 8px;">
            <div style="width: 10px; height: 10px; background: #28a745; border-radius: 50%;"></div>
            <span><strong>Live Data:</strong> Updated {{ current_time.strftime('%I:%M %p') }} • {{ reports|length }} road issues detected across India</span>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <!-- Map Controls -->
            <div class="map-controls">
                <h4 style="margin-top: 0; margin-bottom: 1rem;">
                    <i class="fas fa-layer-group"></i> Map Controls
                </h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="zoomIn()" class="btn btn-sm btn-secondary">
                        <i class="fas fa-plus"></i> Zoom In
                    </button>
                    <button onclick="zoomOut()" class="btn btn-sm btn-secondary">
                        <i class="fas fa-minus"></i> Zoom Out
                    </button>
                    <button onclick="resetView()" class="btn btn-sm btn-secondary">
                        <i class="fas fa-sync-alt"></i> Reset View
                    </button>
                    <button onclick="locateMe()" class="btn btn-sm btn-primary">
                        <i class="fas fa-location-arrow"></i> My Location
                    </button>
                </div>
                
                <div style="margin-top: 1rem;">
                    <h5 style="margin-bottom: 0.5rem;">
                        <i class="fas fa-filter"></i> Filter Issues
                    </h5>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" class="damage-filter" value="high" checked onchange="filterMarkers()">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent-red);"></div>
                            <span>High Priority</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" class="damage-filter" value="medium" checked onchange="filterMarkers()">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent-yellow);"></div>
                            <span>Medium Priority</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" class="damage-filter" value="low" checked onchange="filterMarkers()">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--secondary-green);"></div>
                            <span>Low Priority</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    <p><strong>Tip:</strong> Click on damage markers for details. Drag route points to adjust.</p>
                </div>
            </div>
            
            <!-- Route Controls -->
            <div class="route-controls">
                <h4 style="margin-top: 0; margin-bottom: 1rem;">
                    <i class="fas fa-route"></i> Plan Your Route
                </h4>
                <form id="routeForm">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label class="form-label" style="font-size: 0.9rem;">Starting Location</label>
                        <input type="text" id="startLocation" class="form-control" placeholder="e.g., Mumbai, Delhi, Bangalore" autocomplete="off">
                        <div id="startSuggestions" class="suggestions-box"></div>
                        <small style="display: block; margin-top: 0.3rem; color: #666;">Enter city or place name in India</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label class="form-label" style="font-size: 0.9rem;">Destination</label>
                        <input type="text" id="endLocation" class="form-control" placeholder="e.g., Chennai, Kolkata, Hyderabad" autocomplete="off">
                        <div id="endSuggestions" class="suggestions-box"></div>
                        <small style="display: block; margin-top: 0.3rem; color: #666;">Enter city or place name in India</small>
                    </div>
                    
                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                        <button type="button" onclick="planRouteFromNames()" class="btn btn-primary" style="flex: 1; padding: 8px;">
                            <i class="fas fa-route"></i> Plan Route
                        </button>
                        <button type="button" onclick="clearRoute()" class="btn btn-secondary" style="flex: 1; padding: 8px;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </form>
                
                <!-- Popular Routes -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                    <h5 style="margin-bottom: 0.5rem; font-size: 0.9rem;">
                        <i class="fas fa-bolt"></i> Quick Routes
                    </h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <button onclick="setQuickRoute('Delhi', 'Jaipur')" class="btn btn-sm" style="font-size: 0.8rem; padding: 3px 8px;">
                            Delhi → Jaipur
                        </button>
                        <button onclick="setQuickRoute('Mumbai', 'Pune')" class="btn btn-sm" style="font-size: 0.8rem; padding: 3px 8px;">
                            Mumbai → Pune
                        </button>
                        <button onclick="setQuickRoute('Bangalore', 'Chennai')" class="btn btn-sm" style="font-size: 0.8rem; padding: 3px 8px;">
                            Bangalore → Chennai
                        </button>
                        <button onclick="setQuickRoute('Kolkata', 'Bhubaneswar')" class="btn btn-sm" style="font-size: 0.8rem; padding: 3px 8px;">
                            Kolkata → Bhubaneswar
                        </button>
                    </div>
                </div>
                
                <div id="routeSummary" style="margin-top: 10px; display: none;">
                    <h5 style="margin-bottom: 5px;">Route Summary</h5>
                    <div style="font-size: 0.9rem;">
                        <div><strong>From:</strong> <span id="routeStart">-</span></div>
                        <div><strong>To:</strong> <span id="routeEnd">-</span></div>
                        <div>Distance: <span id="routeDistance">0</span> km</div>
                        <div>Estimated Time: <span id="routeTime">0</span> hours</div>
                        <div style="margin-top: 5px;">Damages on route: 
                            <span class="damage-count high" id="highDamageCount">0</span>
                            <span class="damage-count medium" id="mediumDamageCount">0</span>
                            <span class="damage-count low" id="lowDamageCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Display -->
            <div id="map">
                <!-- Loading Overlay -->
                <div id="mapLoading" class="map-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                
                <!-- Map will be rendered here -->
                <div id="mapTiles" style="width: 100%; height: 100%; position: relative; overflow: hidden;">
                    <!-- India Map Container -->
                    <div id="indiaMap" style="width: 100%; height: 100%; position: relative;">
                        <!-- India map image will be loaded here -->
                        <div id="mapImage" style="width: 100%; height: 100%; background: linear-gradient(135deg, #e9ecef, #dee2e6); position: relative;"></div>
                        <div id="markersContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
                        <div id="routeContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
                        <div id="damagePopup" class="damage-popup"></div>
                        <div id="mapTooltip" class="map-tooltip"></div>
                    </div>
                </div>
            </div>
            
            <!-- Route Info Panel -->
            <div id="routeInfo" class="route-info" style="display: none;">
                <h4 style="margin-top: 0; margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> Route Information
                </h4>
                <div id="routeDetails" style="max-height: 200px; overflow-y: auto;">
                    <!-- Route details will be populated here -->
                </div>
                <button onclick="closeRouteInfo()" style="margin-top: 10px; width: 100%;" class="btn btn-sm btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        
        <!-- Map Legend -->
        <div class="map-legend">
            <div class="legend-item">
                <div class="legend-color legend-red"></div>
                <span>High Priority Damage (Avoid if possible)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-yellow"></div>
                <span>Medium Priority (Proceed with caution)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-green"></div>
                <span>Low Priority (Minor issues)</span>
            </div>
            <div class="legend-item">
                <div style="width: 20px; height: 20px; border-radius: 50%; background: var(--primary-blue); border: 2px solid white;"></div>
                <span>Route Points</span>
            </div>
            <div class="legend-item">
                <div style="width: 20px; height: 4px; background: var(--primary-blue); margin: 8px 0;"></div>
                <span>Your Route</span>
            </div>
        </div>
        
        <!-- Statistics Panel -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0;">
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--accent-red);">
                <h3 style="color: var(--accent-red); font-size: 2rem; margin: 0;" id="statsHigh">
                    {{ reports|selectattr('severity', 'equalto', 'high')|list|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">High Priority Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Needs immediate attention</p>
            </div>
            
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--accent-yellow);">
                <h3 style="color: var(--accent-yellow); font-size: 2rem; margin: 0;" id="statsMedium">
                    {{ reports|selectattr('severity', 'equalto', 'medium')|list|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">Medium Priority Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Schedule within 48 hours</p>
            </div>
            
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--secondary-green);">
                <h3 style="color: var(--secondary-green); font-size: 2rem; margin: 0;" id="statsLow">
                    {{ reports|selectattr('severity', 'equalto', 'low')|list|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">Low Priority Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Monitor for changes</p>
            </div>
            
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--primary-blue);">
                <h3 style="color: var(--primary-blue); font-size: 2rem; margin: 0;" id="statsTotal">
                    {{ reports|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">Total Road Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Across India</p>
            </div>
        </div>
        
        <!-- Major Indian Cities -->
        <div style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem; color: var(--primary-dark);">
                <i class="fas fa-city"></i> Major Indian Cities
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                {% set indian_cities = [
                    ('Delhi', '28.6139', '77.2090'),
                    ('Mumbai', '19.0760', '72.8777'),
                    ('Bangalore', '12.9716', '77.5946'),
                    ('Chennai', '13.0827', '80.2707'),
                    ('Kolkata', '22.5726', '88.3639'),
                    ('Hyderabad', '17.3850', '78.4867'),
                    ('Pune', '18.5204', '73.8567'),
                    ('Ahmedabad', '23.0225', '72.5714'),
                    ('Jaipur', '26.9124', '75.7873'),
                    ('Lucknow', '26.8467', '80.9462')
                ] %}
                
                {% for city, lat, lon in indian_cities %}
                <button onclick="centerOnCity('{{ city }}', {{ lat }}, {{ lon }})" class="btn btn-sm" style="background: var(--light-gray); color: var(--dark-text); border: 1px solid #ddd;">
                    <i class="fas fa-map-marker-alt"></i> {{ city }}
                </button>
                {% endfor %}
            </div>
        </div>
        
        <!-- Action Cards -->
        <div class="card-grid" style="margin-top: 2rem;">
            <div class="card">
                <div class="card-content">
                    <h3><i class="fas fa-info-circle" style="color: var(--secondary-green); margin-right: 10px;"></i> How to Use This Map</h3>
                    <ul style="margin-top: 1rem; padding-left: 1.5rem;">
                        <li><strong>Plan a Route:</strong> Enter start and destination cities in the right panel</li>
                        <li><strong>Quick Routes:</strong> Use predefined routes between major cities</li>
                        <li><strong>View Damages:</strong> Click on colored markers to see damage details</li>
                        <li><strong>Filter Issues:</strong> Use the left panel to show/hide damage types</li>
                        <li><strong>Navigate:</strong> Use zoom buttons or click on city names to navigate</li>
                        <li><strong>My Location:</strong> Click "My Location" to center on your approximate location</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-content">
                    <h3><i class="fas fa-exclamation-triangle" style="color: var(--accent-red); margin-right: 10px;"></i> Safety Recommendations</h3>
                    <div style="margin-top: 1rem;">
                        <div style="padding: 10px; background: rgba(230, 57, 70, 0.1); border-radius: 5px; margin-bottom: 10px;">
                            <strong><i class="fas fa-skull-crossbones"></i> High Priority Areas:</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem;">Avoid these routes if possible. Consider alternative paths.</p>
                        </div>
                        <div style="padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 5px; margin-bottom: 10px;">
                            <strong><i class="fas fa-exclamation-circle"></i> Medium Priority Areas:</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem;">Proceed with caution. Reduce speed in these areas.</p>
                        </div>
                        <div style="padding: 10px; background: rgba(42, 157, 143, 0.1); border-radius: 5px;">
                            <strong><i class="fas fa-info-circle"></i> Low Priority Areas:</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem;">Minor issues. Generally safe for travel.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All Reports Table -->
        <div style="margin-top: 3rem;">
            <h3 style="margin-bottom: 1.5rem;">Road Issues Across India ({{ reports|length }})</h3>
            
            {% if reports %}
            <div style="overflow-x: auto;">
                <table class="reports-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>City/State</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Reported</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>#{{ report._id[:8] }}</td>
                            <td style="text-transform: capitalize;">{{ report.issue_type.replace('_', ' ') }}</td>
                            <td>{{ report.address[:30] }}{% if report.address|length > 30 %}...{% endif %}</td>
                            <td>
                                {% if report.location and report.location.coordinates %}
                                    {% set lat = report.location.coordinates[1] %}
                                    {% set lon = report.location.coordinates[0] %}
                                    {{ get_indian_city(lat, lon) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                <span class="priority-badge priority-{{ report.severity }}">
                                    {{ report.severity|upper }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge badge-{{ report.status.replace(' ', '-') }}">
                                    {{ report.status|title }}
                                </span>
                            </td>
                            <td>{{ report.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <button onclick="centerMapOnLocation({{ report.location.coordinates[1] if report.location else 0 }}, {{ report.location.coordinates[0] if report.location else 0 }})" class="btn btn-sm" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">
                                    <i class="fas fa-map-marker-alt"></i> View
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 3rem; background: white; border-radius: 10px; box-shadow: var(--card-shadow);">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--secondary-green);"></i>
                <h3>No Issues Found</h3>
                <p>There are no road issues in the system yet.</p>
                <a href="{{ url_for('report') }}" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fas fa-plus-circle"></i> Report First Issue
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Damage Details Modal -->
<div id="damageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; width: 90%; max-width: 500px; border-radius: 10px; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0;">Damage Details</h3>
            <button onclick="closeDamageModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
        </div>
        <div id="damageModalContent">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let mapState = {
        center: [20.5937, 78.9629], // Center of India
        zoom: 5,
        scale: 1,
        indiaBounds: {
            minLat: 6.0,   // Southern tip
            maxLat: 37.0,  // Northern tip
            minLon: 68.0,  // Western tip
            maxLon: 97.0   // Eastern tip
        }
    };
    
    let routeState = {
        startPoint: null,
        endPoint: null,
        startName: '',
        endName: '',
        routeLine: null,
        damagesOnRoute: []
    };
    
    let allDamages = {{ reports|tojson|safe }};
    let visibleDamages = [];
    
    // Indian cities database
    const indianCities = {
        "Delhi": [28.6139, 77.2090],
        "Mumbai": [19.0760, 72.8777],
        "Bangalore": [12.9716, 77.5946],
        "Chennai": [13.0827, 80.2707],
        "Kolkata": [22.5726, 88.3639],
        "Hyderabad": [17.3850, 78.4867],
        "Pune": [18.5204, 73.8567],
        "Ahmedabad": [23.0225, 72.5714],
        "Jaipur": [26.9124, 75.7873],
        "Lucknow": [26.8467, 80.9462],
        "Surat": [21.1702, 72.8311],
        "Kanpur": [26.4499, 80.3319],
        "Nagpur": [21.1458, 79.0882],
        "Patna": [25.5941, 85.1376],
        "Indore": [22.7196, 75.8577],
        "Bhopal": [23.2599, 77.4126],
        "Ludhiana": [30.9010, 75.8573],
        "Agra": [27.1767, 78.0081],
        "Nashik": [19.9975, 73.7898],
        "Faridabad": [28.4089, 77.3178],
        "Meerut": [28.9845, 77.7064],
        "Rajkot": [22.3039, 70.8022],
        "Varanasi": [25.3176, 82.9739],
        "Srinagar": [34.0837, 74.7973],
        "Amritsar": [31.6340, 74.8723],
        "Ranchi": [23.3441, 85.3096],
        "Raipur": [21.2514, 81.6296],
        "Jodhpur": [26.2389, 73.0243],
        "Kochi": [9.9312, 76.2673],
        "Guwahati": [26.1445, 91.7362],
        "Chandigarh": [30.7333, 76.7794],
        "Thiruvananthapuram": [8.5241, 76.9366],
        "Bhubaneswar": [20.2961, 85.8245],
        "Dehradun": [30.3165, 78.0322],
        "Gangtok": [27.3389, 88.6065],
        "Shimla": [31.1048, 77.1734],
        "Panaji": [15.4909, 73.8278],
        "Port Blair": [11.6234, 92.7265]
    };
    
    // Initialize map on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
        plotAllDamages();
        updateStatistics();
        setupLocationAutocomplete();
        loadIndiaMap();
    });
    
    // Initialize the map
    function initializeMap() {
        // Set initial map center to India
        centerMap(mapState.center[0], mapState.center[1]);
        
        // Add zoom controls
        document.getElementById('map').addEventListener('wheel', function(e) {
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });
        
        // Add click handler to close popups
        document.getElementById('map').addEventListener('click', function(e) {
            if (e.target.id === 'map' || e.target.id === 'mapImage') {
                closeDamagePopup();
                hideSuggestions();
            }
        });
        
        // Add mousemove for tooltip
        document.getElementById('map').addEventListener('mousemove', function(e) {
            updateTooltip(e);
        });
    }
    
    // Load India map image
    function loadIndiaMap() {
        const mapImage = document.getElementById('mapImage');
        // Using a simple SVG as background for India
        mapImage.innerHTML = `
            <svg width="100%" height="100%" viewBox="0 0 800 800" preserveAspectRatio="xMidYMid meet">
                <!-- India outline - simplified shape -->
                <path d="M200,150 L250,180 L300,200 L350,220 L400,250 L450,280 L500,300 L550,320 L600,350 L650,400 L600,450 L550,500 L500,550 L450,600 L400,620 L350,640 L300,660 L250,680 L200,700 L150,650 L100,600 L80,550 L70,500 L80,450 L100,400 L120,350 L140,300 L160,250 L180,200 Z"
                      fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                
                <!-- Major cities as dots -->
                <circle cx="400" cy="250" r="8" fill="var(--primary-blue)" />
                <circle cx="350" cy="300" r="8" fill="var(--primary-blue)" />
                <circle cx="300" cy="350" r="8" fill="var(--primary-blue)" />
                <circle cx="450" cy="320" r="8" fill="var(--primary-blue)" />
                <circle cx="500" cy="280" r="8" fill="var(--primary-blue)" />
                
                <!-- Text labels -->
                <text x="400" y="240" text-anchor="middle" font-size="12" fill="var(--primary-dark)">Delhi</text>
                <text x="350" y="290" text-anchor="middle" font-size="12" fill="var(--primary-dark)">Mumbai</text>
                <text x="300" y="340" text-anchor="middle" font-size="12" fill="var(--primary-dark)">Bangalore</text>
                <text x="450" y="310" text-anchor="middle" font-size="12" fill="var(--primary-dark)">Kolkata</text>
                <text x="500" y="270" text-anchor="middle" font-size="12" fill="var(--primary-dark)">Chennai</text>
            </svg>
        `;
    }
    
    // Setup location autocomplete
    function setupLocationAutocomplete() {
        const startInput = document.getElementById('startLocation');
        const endInput = document.getElementById('endLocation');
        
        startInput.addEventListener('input', function() {
            showSuggestions(this.value, 'start');
        });
        
        endInput.addEventListener('input', function() {
            showSuggestions(this.value, 'end');
        });
        
        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.suggestions-box') && !e.target.matches('#startLocation, #endLocation')) {
                hideSuggestions();
            }
        });
    }
    
    // Show suggestions for location input
    function showSuggestions(query, type) {
        if (!query || query.length < 2) {
            hideSuggestions();
            return;
        }
        
        const suggestions = Object.keys(indianCities).filter(city => 
            city.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 5);
        
        const suggestionsBox = document.getElementById(type + 'Suggestions');
        suggestionsBox.innerHTML = '';
        
        if (suggestions.length === 0) {
            suggestionsBox.innerHTML = '<div class="suggestion-item">No matches found</div>';
        } else {
            suggestions.forEach(city => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = city;
                item.onclick = function() {
                    document.getElementById(type + 'Location').value = city;
                    hideSuggestions();
                };
                suggestionsBox.appendChild(item);
            });
        }
        
        suggestionsBox.style.display = 'block';
        suggestionsBox.style.width = document.getElementById(type + 'Location').offsetWidth + 'px';
        suggestionsBox.style.top = (document.getElementById(type + 'Location').offsetTop + 
                                   document.getElementById(type + 'Location').offsetHeight) + 'px';
        suggestionsBox.style.left = document.getElementById(type + 'Location').offsetLeft + 'px';
    }
    
    // Hide suggestions
    function hideSuggestions() {
        document.querySelectorAll('.suggestions-box').forEach(box => {
            box.style.display = 'none';
        });
    }
    
    // Center map on specific coordinates
    function centerMap(lat, lon) {
        mapState.center = [lat, lon];
        updateMapView();
    }
    
    // Zoom in
    function zoomIn() {
        mapState.zoom = Math.min(mapState.zoom + 1, 10);
        mapState.scale = Math.pow(1.5, mapState.zoom - 5);
        updateMapView();
        updateMarkers();
    }
    
    // Zoom out
    function zoomOut() {
        mapState.zoom = Math.max(mapState.zoom - 1, 1);
        mapState.scale = Math.pow(1.5, mapState.zoom - 5);
        updateMapView();
        updateMarkers();
    }
    
    // Reset view to India
    function resetView() {
        mapState.center = [20.5937, 78.9629];
        mapState.zoom = 5;
        mapState.scale = 1;
        updateMapView();
        updateMarkers();
    }
    
    // Update map view
    function updateMapView() {
        // In a real implementation, this would update tile positions
        console.log('Map view updated:', mapState);
    }
    
    // Plot all damages on map
    function plotAllDamages() {
        const markersContainer = document.getElementById('markersContainer');
        markersContainer.innerHTML = '';
        
        visibleDamages = allDamages.filter(damage => {
            return damage.location && damage.location.coordinates;
        });
        
        visibleDamages.forEach((damage, index) => {
            const marker = document.createElement('div');
            marker.className = `damage-marker damage-${damage.severity}`;
            marker.dataset.index = index;
            
            // Get coordinates
            const lat = damage.location.coordinates[1];
            const lon = damage.location.coordinates[0];
            
            // Convert coordinates to pixel position on India map
            const pos = latLonToPixel(lat, lon);
            
            marker.style.left = `${pos.x}%`;
            marker.style.top = `${pos.y}%`;
            marker.style.pointerEvents = 'auto';
            
            marker.addEventListener('click', function(e) {
                e.stopPropagation();
                showDamagePopup(damage, pos.x, pos.y);
            });
            
            marker.addEventListener('mouseenter', function(e) {
                showTooltip(damage, e.clientX, e.clientY);
            });
            
            marker.addEventListener('mouseleave', function() {
                hideTooltip();
            });
            
            marker.title = `${damage.issue_type} - ${damage.severity} priority`;
            markersContainer.appendChild(marker);
        });
    }
    
    // Convert latitude/longitude to pixel position on India map
    function latLonToPixel(lat, lon) {
        // Normalize coordinates to India bounds
        const normalizedX = (lon - mapState.indiaBounds.minLon) / 
                          (mapState.indiaBounds.maxLon - mapState.indiaBounds.minLon);
        const normalizedY = 1 - ((lat - mapState.indiaBounds.minLat) / 
                               (mapState.indiaBounds.maxLat - mapState.indiaBounds.minLat));
        
        // Apply zoom scale and center offset
        const centerX = 50;
        const centerY = 50;
        
        const x = centerX + (normalizedX - 0.5) * 80 * mapState.scale;
        const y = centerY + (normalizedY - 0.5) * 80 * mapState.scale;
        
        return { x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) };
    }
    
    // Convert pixel position to latitude/longitude
    function pixelToLatLon(x, y) {
        const centerX = 50;
        const centerY = 50;
        
        const normalizedX = ((x - centerX) / (80 * mapState.scale)) + 0.5;
        const normalizedY = 1 - (((y - centerY) / (80 * mapState.scale)) + 0.5);
        
        const lon = mapState.indiaBounds.minLon + 
                   normalizedX * (mapState.indiaBounds.maxLon - mapState.indiaBounds.minLon);
        const lat = mapState.indiaBounds.minLat + 
                   normalizedY * (mapState.indiaBounds.maxLat - mapState.indiaBounds.minLat);
        
        return { lat, lon };
    }
    
    // Filter markers based on selected types
    function filterMarkers() {
        const filters = Array.from(document.querySelectorAll('.damage-filter:checked')).map(cb => cb.value);
        
        visibleDamages = allDamages.filter(damage => {
            if (!damage.location || !damage.location.coordinates) return false;
            return filters.includes(damage.severity);
        });
        
        updateMarkers();
        updateStatistics();
    }
    
    // Update markers on map
    function updateMarkers() {
        const markersContainer = document.getElementById('markersContainer');
        markersContainer.innerHTML = '';
        
        visibleDamages.forEach((damage, index) => {
            const marker = document.createElement('div');
            marker.className = `damage-marker damage-${damage.severity}`;
            marker.dataset.index = index;
            
            // Get coordinates
            const lat = damage.location.coordinates[1];
            const lon = damage.location.coordinates[0];
            
            // Convert to pixel position
            const pos = latLonToPixel(lat, lon);
            
            marker.style.left = `${pos.x}%`;
            marker.style.top = `${pos.y}%`;
            marker.style.pointerEvents = 'auto';
            
            marker.addEventListener('click', function(e) {
                e.stopPropagation();
                showDamagePopup(damage, pos.x, pos.y);
            });
            
            marker.addEventListener('mouseenter', function(e) {
                showTooltip(damage, e.clientX, e.clientY);
            });
            
            marker.addEventListener('mouseleave', function() {
                hideTooltip();
            });
            
            marker.title = `${damage.issue_type} - ${damage.severity} priority`;
            markersContainer.appendChild(marker);
        });
    }
    
    // Show tooltip
    function showTooltip(damage, x, y) {
        const tooltip = document.getElementById('mapTooltip');
        tooltip.innerHTML = `
            <strong>${damage.issue_type.replace('_', ' ').toUpperCase()}</strong><br>
            Severity: ${damage.severity}<br>
            ${damage.address ? damage.address.substring(0, 30) + '...' : 'No address'}
        `;
        tooltip.style.left = (x + 10) + 'px';
        tooltip.style.top = (y + 10) + 'px';
        tooltip.style.display = 'block';
    }
    
    // Hide tooltip
    function hideTooltip() {
        document.getElementById('mapTooltip').style.display = 'none';
    }
    
    // Update tooltip position
    function updateTooltip(e) {
        const tooltip = document.getElementById('mapTooltip');
        if (tooltip.style.display === 'block') {
            tooltip.style.left = (e.clientX + 10) + 'px';
            tooltip.style.top = (e.clientY + 10) + 'px';
        }
    }
    
    // Show damage popup
    function showDamagePopup(damage, x, y) {
        const popup = document.getElementById('damagePopup');
        popup.innerHTML = `
            <button class="close-popup" onclick="closeDamagePopup()">&times;</button>
            <h4>${damage.issue_type.replace('_', ' ').toUpperCase()}</h4>
            <p><strong>Severity:</strong> <span class="priority-badge priority-${damage.severity}">${damage.severity.toUpperCase()}</span></p>
            <p><strong>Status:</strong> <span class="status-badge badge-${damage.status.replace(' ', '-')}">${damage.status.toUpperCase()}</span></p>
            <p><strong>Location:</strong> ${damage.address || 'Not specified'}</p>
            <p><strong>Reported:</strong> ${new Date(damage.created_at).toLocaleDateString()}</p>
            ${damage.description ? `<p><strong>Description:</strong> ${damage.description.substring(0, 100)}...</p>` : ''}
            <button onclick="showDamageDetails(${JSON.stringify(damage).replace(/"/g, '&quot;')})" class="btn btn-sm btn-primary" style="margin-top: 10px;">
                <i class="fas fa-info-circle"></i> More Details
            </button>
        `;
        
        popup.style.left = `${x}%`;
        popup.style.top = `${y}%`;
        popup.style.display = 'block';
        popup.style.transform = 'translate(-50%, -120%)';
    }
    
    // Close damage popup
    function closeDamagePopup() {
        document.getElementById('damagePopup').style.display = 'none';
    }
    
    // Show damage details modal
    function showDamageDetails(damage) {
        const modal = document.getElementById('damageModal');
        const content = document.getElementById('damageModalContent');
        
        content.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <h4 style="color: var(--primary-dark); margin-bottom: 0.5rem;">
                    ${damage.issue_type.replace('_', ' ').toUpperCase()}
                </h4>
                <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                    <span class="priority-badge priority-${damage.severity}">${damage.severity.toUpperCase()} PRIORITY</span>
                    <span class="status-badge badge-${damage.status.replace(' ', '-')}">${damage.status.toUpperCase()}</span>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong></p>
                <p>${damage.address || 'Location not specified'}</p>
                <p style="font-size: 0.9em; color: #666;">
                    Coordinates: ${damage.location.coordinates[1].toFixed(6)}, ${damage.location.coordinates[0].toFixed(6)}
                </p>
            </div>
            
            ${damage.description ? `
            <div style="margin-bottom: 1rem;">
                <p><strong><i class="fas fa-align-left"></i> Description:</strong></p>
                <p>${damage.description}</p>
            </div>
            ` : ''}
            
            ${damage.images && damage.images.length > 0 ? `
            <div style="margin-bottom: 1rem;">
                <p><strong><i class="fas fa-images"></i> Photos:</strong></p>
                <div style="display: flex; gap: 10px; overflow-x: auto;">
                    ${damage.images.map(img => `
                        <img src="${img}" alt="Damage photo" style="height: 100px; border-radius: 5px;">
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                <p style="margin: 0; font-size: 0.9em;">
                    <i class="fas fa-info-circle"></i> Reported on ${new Date(damage.created_at).toLocaleString()}
                </p>
            </div>
        `;
        
        modal.style.display = 'flex';
    }
    
    // Close damage modal
    function closeDamageModal() {
        document.getElementById('damageModal').style.display = 'none';
    }
    
    // Plan route from location names
    function planRouteFromNames() {
        const startName = document.getElementById('startLocation').value.trim();
        const endName = document.getElementById('endLocation').value.trim();
        
        if (!startName || !endName) {
            alert('Please enter both start and destination locations.');
            return;
        }
        
        // Get coordinates for locations
        const startCoords = indianCities[startName];
        const endCoords = indianCities[endName];
        
        if (!startCoords) {
            alert(`Location "${startName}" not found. Please use a major Indian city name.`);
            return;
        }
        
        if (!endCoords) {
            alert(`Location "${endName}" not found. Please use a major Indian city name.`);
            return;
        }
        
        // Clear previous route
        clearRoute();
        
        // Set route points
        routeState.startPoint = startCoords;
        routeState.endPoint = endCoords;
        routeState.startName = startName;
        routeState.endName = endName;
        
        // Draw route
        drawRoute();
        
        // Find damages along route
        findDamagesOnRoute();
        
        // Show route summary
        document.getElementById('routeSummary').style.display = 'block';
        document.getElementById('routeStart').textContent = startName;
        document.getElementById('routeEnd').textContent = endName;
        
        // Show route info panel
        document.getElementById('routeInfo').style.display = 'block';
        
        // Update route details
        updateRouteDetails();
        
        // Center map on route
        centerMap(
            (startCoords[0] + endCoords[0]) / 2,
            (startCoords[1] + endCoords[1]) / 2
        );
    }
    
    // Set quick route
    function setQuickRoute(start, end) {
        document.getElementById('startLocation').value = start;
        document.getElementById('endLocation').value = end;
        setTimeout(() => planRouteFromNames(), 100);
    }
    
    // Draw route on map
    function drawRoute() {
        const routeContainer = document.getElementById('routeContainer');
        routeContainer.innerHTML = '';
        
        // Convert coordinates to pixel positions
        const startPos = latLonToPixel(routeState.startPoint[0], routeState.startPoint[1]);
        const endPos = latLonToPixel(routeState.endPoint[0], routeState.endPoint[1]);
        
        // Add start point
        const startPoint = document.createElement('div');
        startPoint.className = 'route-point';
        startPoint.style.left = `${startPos.x}%`;
        startPoint.style.top = `${startPos.y}%`;
        startPoint.title = routeState.startName || 'Start Point';
        startPoint.style.pointerEvents = 'auto';
        startPoint.addEventListener('mousedown', startDrag);
        routeContainer.appendChild(startPoint);
        
        // Add end point
        const endPoint = document.createElement('div');
        endPoint.className = 'route-point';
        endPoint.style.left = `${endPos.x}%`;
        endPoint.style.top = `${endPos.y}%`;
        endPoint.title = routeState.endName || 'End Point';
        endPoint.style.pointerEvents = 'auto';
        endPoint.addEventListener('mousedown', startDrag);
        routeContainer.appendChild(endPoint);
        
        // Add route line
        const routeLine = document.createElement('div');
        routeLine.className = 'route-line';
        routeLine.style.left = `${startPos.x}%`;
        routeLine.style.top = `${startPos.y}%`;
        
        // Calculate line length and angle
        const dx = endPos.x - startPos.x;
        const dy = endPos.y - startPos.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * (180 / Math.PI);
        
        routeLine.style.width = `${length}%`;
        routeLine.style.height = '4px';
        routeLine.style.background = 'var(--primary-blue)';
        routeLine.style.transform = `rotate(${angle}deg)`;
        routeLine.style.transformOrigin = '0 0';
        
        routeContainer.appendChild(routeLine);
        
        routeState.routeLine = routeLine;
    }
    
    // Drag functionality for route points
    let dragElement = null;
    let offsetX = 0;
    let offsetY = 0;
    
    function startDrag(e) {
        dragElement = e.target;
        const rect = dragElement.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        e.preventDefault();
    }
    
    function drag(e) {
        if (!dragElement) return;
        
        const mapRect = document.getElementById('map').getBoundingClientRect();
        const x = ((e.clientX - mapRect.left - offsetX) / mapRect.width) * 100;
        const y = ((e.clientY - mapRect.top - offsetY) / mapRect.height) * 100;
        
        dragElement.style.left = `${Math.max(0, Math.min(100, x))}%`;
        dragElement.style.top = `${Math.max(0, Math.min(100, y))}%`;
        
        // Update route line
        updateRouteLine();
    }
    
    function stopDrag() {
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        dragElement = null;
        
        // Recalculate damages on route
        findDamagesOnRoute();
        updateRouteDetails();
    }
    
    function updateRouteLine() {
        const routePoints = document.querySelectorAll('.route-point');
        if (routePoints.length !== 2) return;
        
        const startPoint = routePoints[0];
        const endPoint = routePoints[1];
        
        const startX = parseFloat(startPoint.style.left);
        const startY = parseFloat(startPoint.style.top);
        const endX = parseFloat(endPoint.style.left);
        const endY = parseFloat(endPoint.style.top);
        
        const dx = endX - startX;
        const dy = endY - startY;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * (180 / Math.PI);
        
        if (routeState.routeLine) {
            routeState.routeLine.style.left = `${startX}%`;
            routeState.routeLine.style.top = `${startY}%`;
            routeState.routeLine.style.width = `${length}%`;
            routeState.routeLine.style.transform = `rotate(${angle}deg)`;
        }
    }
    
    // Find damages along the route
    function findDamagesOnRoute() {
        routeState.damagesOnRoute = [];
        
        visibleDamages.forEach(damage => {
            if (isDamageNearRoute(damage)) {
                routeState.damagesOnRoute.push(damage);
            }
        });
        
        // Update damage counts
        const highCount = routeState.damagesOnRoute.filter(d => d.severity === 'high').length;
        const mediumCount = routeState.damagesOnRoute.filter(d => d.severity === 'medium').length;
        const lowCount = routeState.damagesOnRoute.filter(d => d.severity === 'low').length;
        
        document.getElementById('highDamageCount').textContent = highCount;
        document.getElementById('mediumDamageCount').textContent = mediumCount;
        document.getElementById('lowDamageCount').textContent = lowCount;
        
        // Calculate route distance and time
        const distance = calculateDistance(
            routeState.startPoint[0], routeState.startPoint[1],
            routeState.endPoint[0], routeState.endPoint[1]
        );
        
        document.getElementById('routeDistance').textContent = distance.toFixed(0);
        document.getElementById('routeTime').textContent = (distance / 60).toFixed(1); // 60 km/h average speed
    }
    
    // Check if damage is near route
    function isDamageNearRoute(damage) {
        if (!damage.location || !damage.location.coordinates) return false;
        
        const damageLat = damage.location.coordinates[1];
        const damageLon = damage.location.coordinates[0];
        
        // Calculate distance from damage to route line
        const distance = distanceToLine(
            damageLat, damageLon,
            routeState.startPoint[0], routeState.startPoint[1],
            routeState.endPoint[0], routeState.endPoint[1]
        );
        
        // Consider damage near if within 50km of route (for India scale)
        return distance <= 50;
    }
    
    // Calculate distance between two points (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    // Calculate distance from point to line segment
    function distanceToLine(pointLat, pointLon, lineLat1, lineLon1, lineLat2, lineLon2) {
        // Simplified calculation for India scale
        const toRad = Math.PI / 180;
        
        const lat1 = lineLat1 * toRad;
        const lon1 = lineLon1 * toRad;
        const lat2 = lineLat2 * toRad;
        const lon2 = lineLon2 * toRad;
        const latp = pointLat * toRad;
        const lonp = pointLon * toRad;
        
        // Calculate bearing
        const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
        const x = Math.cos(lat1) * Math.sin(lat2) - 
                 Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
        const bearing = Math.atan2(y, x);
        
        // Calculate distance from point to line
        const distance = Math.asin(Math.sin(lat1) * Math.sin(latp) + 
                                  Math.cos(lat1) * Math.cos(latp) * Math.cos(lonp - lon1)) * 6371;
        
        return Math.abs(distance * Math.sin(bearing - Math.atan2(
            Math.sin(lonp - lon1) * Math.cos(latp),
            Math.cos(lat1) * Math.sin(latp) - Math.sin(lat1) * Math.cos(latp) * Math.cos(lonp - lon1)
        )));
    }
    
    // Update route details panel
    function updateRouteDetails() {
        const routeDetails = document.getElementById('routeDetails');
        routeDetails.innerHTML = '';
        
        if (routeState.damagesOnRoute.length === 0) {
            routeDetails.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--secondary-green);"></i>
                    <p>No damages detected on this route!</p>
                    <p style="font-size: 0.9em; color: #666;">Safe travels across India!</p>
                </div>
            `;
            return;
        }
        
        // Group damages by severity
        const damagesBySeverity = {
            high: routeState.damagesOnRoute.filter(d => d.severity === 'high'),
            medium: routeState.damagesOnRoute.filter(d => d.severity === 'medium'),
            low: routeState.damagesOnRoute.filter(d => d.severity === 'low')
        };
        
        Object.entries(damagesBySeverity).forEach(([severity, damages]) => {
            if (damages.length > 0) {
                const severityDiv = document.createElement('div');
                severityDiv.style.marginBottom = '1rem';
                severityDiv.style.padding = '10px';
                severityDiv.style.background = severity === 'high' ? 'rgba(230, 57, 70, 0.1)' : 
                                            severity === 'medium' ? 'rgba(255, 193, 7, 0.1)' : 
                                            'rgba(42, 157, 143, 0.1)';
                severityDiv.style.borderRadius = '5px';
                severityDiv.style.borderLeft = `4px solid ${
                    severity === 'high' ? 'var(--accent-red)' : 
                    severity === 'medium' ? 'var(--accent-yellow)' : 
                    'var(--secondary-green)'
                }`;
                
                severityDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong style="text-transform: capitalize;">${severity} Priority</strong>
                        <span class="damage-count ${severity}">${damages.length}</span>
                    </div>
                    <div style="font-size: 0.9em;">
                        ${damages.slice(0, 3).map(d => `
                            <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.5); border-radius: 3px;">
                                <strong>${d.issue_type.replace('_', ' ')}</strong><br>
                                ${d.address ? d.address.substring(0, 30) + '...' : 'No address'}
                            </div>
                        `).join('')}
                        ${damages.length > 3 ? `<p style="margin: 5px 0 0; font-size: 0.8em; color: #666;">... and ${damages.length - 3} more</p>` : ''}
                    </div>
                `;
                
                routeDetails.appendChild(severityDiv);
            }
        });
        
        // Add safety recommendations
        const highCount = damagesBySeverity.high.length;
        const mediumCount = damagesBySeverity.medium.length;
        
        if (highCount > 0) {
            const warningDiv = document.createElement('div');
            warningDiv.style.padding = '10px';
            warningDiv.style.background = 'rgba(230, 57, 70, 0.1)';
            warningDiv.style.borderRadius = '5px';
            warningDiv.style.border = '1px solid var(--accent-red)';
            warningDiv.style.marginTop = '1rem';
            
            warningDiv.innerHTML = `
                <strong><i class="fas fa-exclamation-triangle"></i> Safety Warning:</strong>
                <p style="margin: 5px 0 0; font-size: 0.9em;">
                    This route has ${highCount} high-priority damage${highCount > 1 ? 's' : ''}. 
                    ${highCount > 2 ? 'Strongly consider an alternative route.' : 'Proceed with extreme caution.'}
                </p>
            `;
            
            routeDetails.appendChild(warningDiv);
        }
    }
    
    // Clear route
    function clearRoute() {
        routeState.startPoint = null;
        routeState.endPoint = null;
        routeState.startName = '';
        routeState.endName = '';
        routeState.damagesOnRoute = [];
        
        document.getElementById('routeContainer').innerHTML = '';
        document.getElementById('routeSummary').style.display = 'none';
        document.getElementById('routeInfo').style.display = 'none';
        document.getElementById('startLocation').value = '';
        document.getElementById('endLocation').value = '';
    }
    
    // Close route info panel
    function closeRouteInfo() {
        document.getElementById('routeInfo').style.display = 'none';
    }
    
    // Use current location (simulated for India)
    function locateMe() {
        showLoading(true);
        
        // Simulate geolocation with common Indian cities
        const cities = ['Delhi', 'Mumbai', 'Bangalore', 'Chennai', 'Kolkata'];
        const randomCity = cities[Math.floor(Math.random() * cities.length)];
        const coords = indianCities[randomCity];
        
        setTimeout(() => {
            centerMap(coords[0], coords[1]);
            mapState.zoom = 8;
            mapState.scale = Math.pow(1.5, mapState.zoom - 5);
            updateMapView();
            updateMarkers();
            
            // Show notification
            alert(`Your location is approximated to ${randomCity}. For accurate location, enable browser geolocation.`);
            
            showLoading(false);
        }, 1000);
    }
    
    // Center on city
    function centerOnCity(city, lat, lon) {
        centerMap(lat, lon);
        mapState.zoom = 8;
        mapState.scale = Math.pow(1.5, mapState.zoom - 5);
        updateMapView();
        updateMarkers();
    }
    
    // Center map on specific location
    function centerMapOnLocation(lat, lon) {
        if (lat && lon) {
            centerMap(lat, lon);
            mapState.zoom = 10;
            mapState.scale = Math.pow(1.5, mapState.zoom - 5);
            updateMapView();
            updateMarkers();
        }
    }
    
    // Show loading overlay
    function showLoading(show) {
        document.getElementById('mapLoading').style.display = show ? 'flex' : 'none';
    }
    
    // Update statistics display
    function updateStatistics() {
        const highCount = visibleDamages.filter(d => d.severity === 'high').length;
        const mediumCount = visibleDamages.filter(d => d.severity === 'medium').length;
        const lowCount = visibleDamages.filter(d => d.severity === 'low').length;
        const totalCount = visibleDamages.length;
        
        document.getElementById('statsHigh').textContent = highCount;
        document.getElementById('statsMedium').textContent = mediumCount;
        document.getElementById('statsLow').textContent = lowCount;
        document.getElementById('statsTotal').textContent = totalCount;
    }
    
    // Handle keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return;
        
        switch(e.key) {
            case '+':
            case '=':
                zoomIn();
                break;
            case '-':
                zoomOut();
                break;
            case 'Escape':
                closeDamagePopup();
                closeDamageModal();
                hideSuggestions();
                break;
        }
    });
</script>
{% endblock %}