{% extends "base.html" %}

{% block title %}Live Road Map - Smart Road Monitor{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        z-index: 1;
    }
    
    .map-wrapper {
        position: relative;
        margin-bottom: 2rem;
    }
    
    .map-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-width: 300px;
    }
    
    .routing-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .route-input {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    
    .route-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        min-width: 200px;
    }
    
    .damage-alert {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }
    
    .damage-alert.show {
        display: block;
    }
    
    .damage-marker {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .damage-marker i {
        color: #dc3545;
    }
    
    .route-summary {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .custom-marker {
        background: transparent;
    }
    
    .marker-high, .marker-medium, .marker-low, .marker-current, .marker-start, .marker-end {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        border: 2px solid white;
    }
    
    .marker-high { background: #dc3545; }
    .marker-medium { background: #ffc107; color: #333; }
    .marker-low { background: #28a745; }
    .marker-current { background: #007bff; }
    .marker-start { background: #28a745; }
    .marker-end { background: #dc3545; }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-right: 20px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }
    
    .legend-red { background: #dc3545; }
    .legend-yellow { background: #ffc107; }
    .legend-green { background: #28a745; }
    .legend-blue { background: #007bff; }
    .legend-route { color: #4285F4; }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #2a9d8f;
        color: white;
    }
    
    .btn-primary:hover {
        background: #238b7e;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
    }
    
    .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9);
        padding: 15px 30px;
        border-radius: 50px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 10px;
    }
    
    .loading i {
        color: #2a9d8f;
    }
    
    .location-actions {
        display: flex;
        gap: 10px;
        margin: 10px 0;
        flex-wrap: wrap;
    }
    
    .location-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
    }
    
    .location-btn-from {
        background: #28a745;
        color: white;
    }
    
    .location-btn-from:hover {
        background: #218838;
    }
    
    .location-btn-to {
        background: #dc3545;
        color: white;
    }
    
    .location-btn-to:hover {
        background: #c82333;
    }
    
    .location-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 5px;
    }
    
    .badge-current {
        background: #007bff;
        color: white;
    }
    
    .popular-routes {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .place-chips {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    
    .place-chip {
        padding: 6px 12px;
        background: #e9ecef;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .place-chip:hover {
        background: #2a9d8f;
        color: white;
    }
    
    .coordinate-info {
        font-size: 11px;
        color: #666;
        margin-top: 2px;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero" style="padding: 3rem 0;">
    <div class="container">
        <div class="hero-content">
            <h1>Live Road Condition Map</h1>
            <p>Real-time monitoring of road conditions with AI-powered detection and citizen reports</p>
        </div>
    </div>
</section>

<!-- Map Section -->
<section class="section-padding">
    <div class="container">
        <!-- Live Status -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; padding: 10px 15px; background: rgba(42, 157, 143, 0.1); border-radius: 8px;">
            <div style="width: 10px; height: 10px; background: #28a745; border-radius: 50%; animation: pulse 2s infinite;"></div>
            <span><strong>Live Data:</strong> Updated {{ current_time.strftime('%I:%M %p') }} ‚Ä¢ <span id="activeIssuesCount">{{ reports|length }}</span> active issues on map</span>
        </div>
        
        <!-- Routing Section -->
        <div class="routing-panel">
            <h3 style="margin-bottom: 1rem;"><i class="fas fa-route"></i> Plan Your Route</h3>
            <div class="route-input">
                <div style="flex: 1; position: relative;">
                    <input type="text" id="from-location" placeholder="From (e.g., Chennai)" value="Chennai, Tamil Nadu">
                    <span id="from-badge" class="location-badge badge-current" style="display: none;">üìç Current</span>
                </div>
                <div style="flex: 1; position: relative;">
                    <input type="text" id="to-location" placeholder="To (e.g., Tirupati)" value="Tirupati, Andhra Pradesh">
                    <span id="to-badge" class="location-badge badge-current" style="display: none;">üìç Current</span>
                </div>
                <button onclick="calculateRoute()" class="btn btn-primary">
                    <i class="fas fa-search"></i> Get Route
                </button>
            </div>
            
            <div class="location-actions">
                <button onclick="detectCurrentLocation()" class="btn btn-secondary">
                    <i class="fas fa-location-arrow"></i> Detect My Location
                </button>
                <button onclick="setFromToCurrent()" class="location-btn location-btn-from" id="setFromBtn" disabled>
                    <i class="fas fa-play"></i> Start from Here
                </button>
                <button onclick="setToToCurrent()" class="location-btn location-btn-to" id="setToBtn" disabled>
                    <i class="fas fa-flag-checkered"></i> Go to Here
                </button>
                <button onclick="swapLocations()" class="btn btn-secondary">
                    <i class="fas fa-exchange-alt"></i> Swap
                </button>
                <button onclick="clearRoute()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            
            <!-- Popular Routes -->
            <div class="popular-routes">
                <h4 style="margin-bottom: 10px;"><i class="fas fa-star" style="color: #ffc107;"></i> Popular Routes:</h4>
                <div class="place-chips">
                    <span class="place-chip" onclick="setRoute('Chennai, Tamil Nadu', 'Tirupati, Andhra Pradesh')">Chennai ‚Üí Tirupati</span>
                    <span class="place-chip" onclick="setRoute('Mumbai, Maharashtra', 'Pune, Maharashtra')">Mumbai ‚Üí Pune</span>
                    <span class="place-chip" onclick="setRoute('Delhi', 'Agra, Uttar Pradesh')">Delhi ‚Üí Agra</span>
                    <span class="place-chip" onclick="setRoute('Bangalore, Karnataka', 'Mysore, Karnataka')">Bangalore ‚Üí Mysore</span>
                    <span class="place-chip" onclick="setRoute('Hyderabad, Telangana', 'Vijayawada, Andhra Pradesh')">Hyderabad ‚Üí Vijayawada</span>
                    <span class="place-chip" onclick="setRoute('Kolkata, West Bengal', 'Digha, West Bengal')">Kolkata ‚Üí Digha</span>
                </div>
            </div>
            
            <!-- Location Status -->
            <div id="locationStatus" style="background: #e7f5ff; padding: 10px 15px; border-radius: 8px; margin-top: 10px; display: none;">
                <i class="fas fa-info-circle"></i>
                <span id="locationStatusText"></span>
            </div>
            
            <!-- Damage Alert -->
            <div id="damageAlert" class="damage-alert">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="damageMessage"></span>
            </div>
            
            <!-- Route Summary -->
            <div id="routeSummary" class="route-summary" style="display: none;">
                <h4>Route Summary</h4>
                <p id="routeDistance"></p>
                <p id="routeTime"></p>
                <p id="damageCount"></p>
            </div>
        </div>
        
        <!-- Map Legend -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 1rem; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <div class="legend-item">
                <div class="legend-color legend-red"></div>
                <span>High Priority (Dangerous)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-yellow"></div>
                <span>Medium Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-green"></div>
                <span>Low Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-blue"></div>
                <span>Your Location</span>
            </div>
            <div class="legend-item">
                <i class="fas fa-route legend-route"></i>
                <span>Route Path</span>
            </div>
            <div class="legend-item">
                <i class="fas fa-play" style="color: #28a745;"></i>
                <span>Start Point</span>
            </div>
            <div class="legend-item">
                <i class="fas fa-flag-checkered" style="color: #dc3545;"></i>
                <span>End Point</span>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-wrapper">
            <div id="map"></div>
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i> Processing...
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <h4><i class="fas fa-filter"></i> Filter Damages</h4>
                <div style="margin-top: 10px;">
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="showHigh" checked onchange="filterMarkers()"> High Priority
                    </label>
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="showMedium" checked onchange="filterMarkers()"> Medium Priority
                    </label>
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" id="showLow" checked onchange="filterMarkers()"> Low Priority
                    </label>
                </div>
                <hr>
                <button onclick="centerMap()" class="btn btn-sm btn-secondary" style="width: 100%;">
                    <i class="fas fa-crosshairs"></i> Center Map
                </button>
            </div>
        </div>
        
        <!-- Statistics Panel -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0;">
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid #dc3545;">
                <h3 style="color: #dc3545; font-size: 2rem; margin: 0;" id="statHigh">
                    {{ reports|selectattr('severity', 'equalto', 'high')|list|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">High Priority Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Needs immediate attention</p>
            </div>
            
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid #ffc107;">
                <h3 style="color: #ffc107; font-size: 2rem; margin: 0;" id="statMedium">
                    {{ reports|selectattr('severity', 'equalto', 'medium')|list|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">Medium Priority Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Schedule within 48 hours</p>
            </div>
            
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid #28a745;">
                <h3 style="color: #28a745; font-size: 2rem; margin: 0;" id="statLow">
                    {{ reports|selectattr('severity', 'equalto', 'low')|list|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">Low Priority Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Monitor for changes</p>
            </div>
            
            <div style="background: white; padding: 1.5rem; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid #2a9d8f;">
                <h3 style="color: #2a9d8f; font-size: 2rem; margin: 0;" id="statTotal">
                    {{ reports|length }}
                </h3>
                <p style="margin: 0.5rem 0 0; font-weight: 600;">Total Issues</p>
                <p style="font-size: 0.9rem; color: #666; margin: 5px 0 0;">Across all roads</p>
            </div>
        </div>
        
        <!-- Action Cards -->
        <div class="card-grid" style="margin-top: 2rem;">
            <div class="card">
                <div class="card-content">
                    <h3><i class="fas fa-info-circle" style="color: var(--secondary-green); margin-right: 10px;"></i> How to Use This Map</h3>
                    <ul style="margin-top: 1rem; padding-left: 1.5rem;">
                        <li>Click on markers to see road damage details</li>
                        <li>Enter locations above to get route with damage alerts</li>
                        <li>Red markers indicate dangerous areas to avoid</li>
                        <li>The map will show damage hotspots along your route</li>
                        <li>Use filters to focus on specific priority levels</li>
                    </ul>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <a href="{{ url_for('report') }}" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Report New Issue
                        </a>
                        <button onclick="location.reload()" class="btn btn-secondary">
                            <i class="fas fa-sync-alt"></i> Refresh Map
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-content">
                    <h3><i class="fas fa-filter" style="color: var(--secondary-green); margin-right: 10px;"></i> Filter Issues</h3>
                    <form action="{{ url_for('map_page') }}" method="get" style="margin-top: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Priority Level</label>
                            <select name="priority" class="form-control">
                                <option value="">All Priorities</option>
                                <option value="high">High Priority</option>
                                <option value="medium">Medium Priority</option>
                                <option value="low">Low Priority</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Issue Type</label>
                            <select name="type" class="form-control">
                                <option value="">All Types</option>
                                <option value="pothole">Pothole</option>
                                <option value="crack">Crack</option>
                                <option value="speed_hump">Speed Hump</option>
                                <option value="debris">Debris</option>
                                <option value="flooding">Flooding</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-control">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="assigned">Assigned</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- All Reports Table -->
        <div style="margin-top: 3rem;">
            <h3 style="margin-bottom: 1.5rem;">All Road Issues ({{ reports|length }})</h3>
            
            {% if reports %}
            <div style="overflow-x: auto;">
                <table class="reports-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Reported</th>
                            <th>Distance from Route</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>#{{ report._id[:8] }}</td>
                            <td style="text-transform: capitalize;">{{ report.issue_type.replace('_', ' ') }}</td>
                            <td>{{ report.address[:30] }}{% if report.address|length > 30 %}...{% endif %}</td>
                            <td>
                                <span class="priority-badge priority-{{ report.severity }}">
                                    {{ report.severity|upper }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge badge-{{ report.status.replace(' ', '-') }}">
                                    {{ report.status|title }}
                                </span>
                            </td>
                            <td>{{ report.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <span class="route-distance" data-lat="{{ report.latitude|default(0) }}" data-lng="{{ report.longitude|default(0) }}">
                                    Not in route
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('view_report', report_id=report._id) }}" class="btn btn-sm" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <button onclick="flyToLocation({{ report.latitude|default(0) }}, {{ report.longitude|default(0) }})" class="btn btn-sm" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">
                                    <i class="fas fa-map-marker-alt"></i> Locate
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 3rem; background: white; border-radius: 10px; box-shadow: var(--card-shadow);">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--secondary-green);"></i>
                <h3>No Issues Found</h3>
                <p>There are no road issues matching your criteria.</p>
                <a href="{{ url_for('map_page') }}" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fas fa-redo"></i> Clear Filters
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing map...');
    initMap();
});

// Global variables
var map;
var markers = [];
var routingControl = null;
var currentLocationMarker = null;
var currentLocationCoords = null;
var startMarker = null;
var endMarker = null;
var currentRoute = null;

// Road damages from database
var roadDamages = [
    {% for report in reports %}
    {
        id: '{{ report._id }}',
        lat: {{ report.latitude|default(13.0827) }},
        lng: {{ report.longitude|default(80.2707) }},
        type: '{{ report.issue_type|default('pothole') }}',
        severity: '{{ report.severity|default('medium') }}',
        address: '{{ report.address|default('Unknown')|safe }}',
        status: '{{ report.status|default('pending') }}'
    },
    {% endfor %}
];

// If no reports, add sample data for demonstration
if (roadDamages.length === 0) {
    roadDamages = [
        { lat: 13.0827, lng: 80.2707, severity: 'high', type: 'pothole', address: 'Chennai Central', status: 'pending' },
        { lat: 13.0639, lng: 80.2429, severity: 'medium', type: 'crack', address: 'Mount Road', status: 'assigned' },
        { lat: 13.0285, lng: 80.2045, severity: 'low', type: 'speed_hump', address: 'GST Road', status: 'pending' },
        { lat: 12.9689, lng: 79.9485, severity: 'high', type: 'pothole', address: 'Sriperumbudur', status: 'pending' },
        { lat: 12.9165, lng: 79.1325, severity: 'high', type: 'pothole', address: 'Vellore', status: 'pending' },
        { lat: 13.6288, lng: 79.4192, severity: 'high', type: 'pothole', address: 'Tirupati', status: 'pending' }
    ];
}

// ==================== MAP INITIALIZATION ====================
function initMap() {
    // Create map
    map = L.map('map').setView([13.0827, 80.2707], 8);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add road damage markers
    addMarkers();
    
    // Pre-fill example
    document.getElementById('from-location').value = 'Chennai, Tamil Nadu';
    document.getElementById('to-location').value = 'Tirupati, Andhra Pradesh';
    
    // Auto-calculate after delay
    setTimeout(calculateRoute, 1000);
}

// ==================== MARKER FUNCTIONS ====================
function addMarkers() {
    // Clear existing markers
    markers.forEach(marker => {
        if (map && marker) map.removeLayer(marker);
    });
    markers = [];
    
    // Add markers for each damage
    roadDamages.forEach(damage => {
        if (!damage.lat || !damage.lng) return;
        
        var marker = L.marker([damage.lat, damage.lng], {
            icon: createMarkerIcon(damage.severity)
        }).addTo(map);
        
        // Popup content
        var popupContent = `
            <div style="min-width: 200px;">
                <h4 style="margin: 0 0 10px 0; color: #333;">${damage.type.toUpperCase().replace('_', ' ')}</h4>
                <p><strong>Priority:</strong> 
                    <span style="color: ${damage.severity === 'high' ? '#dc3545' : (damage.severity === 'medium' ? '#ffc107' : '#28a745')}; font-weight: bold;">
                        ${damage.severity.toUpperCase()}
                    </span>
                </p>
                <p><strong>Status:</strong> ${damage.status}</p>
                <p><strong>Location:</strong> ${damage.address}</p>
                <button onclick="flyToLocation(${damage.lat}, ${damage.lng})" style="padding: 5px 10px; background: #2a9d8f; color: white; border: none; border-radius: 3px; cursor: pointer; margin-top: 5px;">
                    <i class="fas fa-location-arrow"></i> Center
                </button>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        marker.damageData = damage;
        markers.push(marker);
    });
    
    updateStatistics();
}

function createMarkerIcon(severity) {
    var className = 'marker-' + (severity || 'medium');
    var iconChar = severity === 'high' ? '!' : (severity === 'medium' ? '‚Ä¢' : '‚úì');
    
    return L.divIcon({
        className: 'custom-marker',
        html: `<div class="${className}">${iconChar}</div>`,
        iconSize: [30, 30],
        popupAnchor: [0, -15]
    });
}

// ==================== FILTER FUNCTIONS ====================
function filterMarkers() {
    var showHigh = document.getElementById('showHigh').checked;
    var showMedium = document.getElementById('showMedium').checked;
    var showLow = document.getElementById('showLow').checked;
    
    markers.forEach(marker => {
        var severity = marker.damageData.severity;
        var shouldShow = (
            (severity === 'high' && showHigh) ||
            (severity === 'medium' && showMedium) ||
            (severity === 'low' && showLow)
        );
        
        if (shouldShow && !map.hasLayer(marker)) {
            marker.addTo(map);
        } else if (!shouldShow && map.hasLayer(marker)) {
            map.removeLayer(marker);
        }
    });
}

// ==================== LOCATION FUNCTIONS ====================
function detectCurrentLocation() {
    if (!navigator.geolocation) {
        showAlert('Geolocation is not supported by your browser', 'warning');
        return;
    }
    
    showLoading();
    document.getElementById('locationStatus').style.display = 'block';
    document.getElementById('locationStatusText').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting your location...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            currentLocationCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            // Remove existing marker
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            
            // Add new marker
            currentLocationMarker = L.marker([currentLocationCoords.lat, currentLocationCoords.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div class="marker-current"><i class="fas fa-user"></i></div>',
                    iconSize: [30, 30]
                })
            }).addTo(map)
              .bindPopup('<strong>Your Current Location</strong>')
              .openPopup();
            
            map.setView([currentLocationCoords.lat, currentLocationCoords.lng], 12);
            
            // Reverse geocode
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocationCoords.lat}&lon=${currentLocationCoords.lng}`)
                .then(response => response.json())
                .then(data => {
                    var locationName = data.display_name ? data.display_name.split(',')[0] : 'Your Location';
                    document.getElementById('locationStatusText').innerHTML = 
                        `<i class="fas fa-check-circle" style="color:#28a745;"></i> Location detected: ${locationName}`;
                    
                    document.getElementById('setFromBtn').disabled = false;
                    document.getElementById('setToBtn').disabled = false;
                    hideLoading();
                })
                .catch(() => {
                    document.getElementById('locationStatusText').innerHTML = 
                        '<i class="fas fa-check-circle" style="color:#28a745;"></i> Location detected successfully';
                    document.getElementById('setFromBtn').disabled = false;
                    document.getElementById('setToBtn').disabled = false;
                    hideLoading();
                });
        },
        function(error) {
            var errorMsg = 'Error getting location: ' + (error.message || 'Unknown error');
            document.getElementById('locationStatusText').innerHTML = 
                `<i class="fas fa-exclamation-triangle" style="color:#dc3545;"></i> ${errorMsg}`;
            showAlert(errorMsg, 'danger');
            hideLoading();
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function setFromToCurrent() {
    if (!currentLocationCoords) {
        showAlert('Please detect your location first', 'warning');
        detectCurrentLocation();
        return;
    }
    
    document.getElementById('from-location').value = 'üìç My Current Location';
    document.getElementById('from-badge').style.display = 'inline';
    
    if (startMarker) map.removeLayer(startMarker);
    startMarker = L.marker([currentLocationCoords.lat, currentLocationCoords.lng], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: '<div class="marker-start"><i class="fas fa-play"></i></div>',
            iconSize: [30, 30]
        })
    }).addTo(map).bindPopup('<strong>Start Point</strong>');
    
    showAlert('Start point set to your current location', 'success');
}

function setToToCurrent() {
    if (!currentLocationCoords) {
        showAlert('Please detect your location first', 'warning');
        detectCurrentLocation();
        return;
    }
    
    document.getElementById('to-location').value = 'üìç My Current Location';
    document.getElementById('to-badge').style.display = 'inline';
    
    if (endMarker) map.removeLayer(endMarker);
    endMarker = L.marker([currentLocationCoords.lat, currentLocationCoords.lng], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: '<div class="marker-end"><i class="fas fa-flag-checkered"></i></div>',
            iconSize: [30, 30]
        })
    }).addTo(map).bindPopup('<strong>Destination Point</strong>');
    
    showAlert('Destination set to your current location', 'success');
}

// ==================== ROUTE FUNCTIONS ====================
async function geocodeLocation(location) {
    // Check if it's current location
    if (location.includes('üìç My Current Location') && currentLocationCoords) {
        return {
            lat: currentLocationCoords.lat,
            lng: currentLocationCoords.lng,
            name: 'Current Location'
        };
    }
    
    showLoading();
    
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&countrycodes=in&limit=1`,
            { headers: { 'User-Agent': 'RoadMonitor/1.0' } }
        );
        const data = await response.json();
        
        if (data && data.length > 0) {
            hideLoading();
            return {
                lat: parseFloat(data[0].lat),
                lng: parseFloat(data[0].lon),
                name: data[0].display_name.split(',')[0]
            };
        }
    } catch (error) {
        console.log('Geocoding error, using fallback');
    }
    
    hideLoading();
    return getFallbackCoordinates(location);
}

function getFallbackCoordinates(location) {
    location = location.toLowerCase();
    var coords = { lat: 13.0827, lng: 80.2707, name: 'Chennai' }; // Default
    
    var cityMap = {
        'chennai': { lat: 13.0827, lng: 80.2707 },
        'tirupati': { lat: 13.6288, lng: 79.4192 },
        'mumbai': { lat: 19.0760, lng: 72.8777 },
        'pune': { lat: 18.5204, lng: 73.8567 },
        'delhi': { lat: 28.6139, lng: 77.2090 },
        'agra': { lat: 27.1767, lng: 78.0081 },
        'bangalore': { lat: 12.9716, lng: 77.5946 },
        'mysore': { lat: 12.2958, lng: 76.6394 },
        'hyderabad': { lat: 17.3850, lng: 78.4867 },
        'kolkata': { lat: 22.5726, lng: 88.3639 }
    };
    
    for (var city in cityMap) {
        if (location.includes(city)) {
            coords = cityMap[city];
            coords.name = city;
            break;
        }
    }
    
    return coords;
}

async function calculateRoute() {
    var from = document.getElementById('from-location').value.trim();
    var to = document.getElementById('to-location').value.trim();
    
    if (!from || !to) {
        showAlert('Please enter both locations', 'warning');
        return;
    }
    
    showLoading();
    
    try {
        const [fromCoords, toCoords] = await Promise.all([
            geocodeLocation(from),
            geocodeLocation(to)
        ]);
        
        if (!fromCoords || !toCoords) {
            showAlert('Could not find one or both locations', 'danger');
            hideLoading();
            return;
        }
        
        createRoute([fromCoords.lat, fromCoords.lng], [toCoords.lat, toCoords.lng]);
        
        // Update input fields if not current location
        if (!from.includes('üìç') && fromCoords.name) {
            document.getElementById('from-location').value = fromCoords.name;
        }
        if (!to.includes('üìç') && toCoords.name) {
            document.getElementById('to-location').value = toCoords.name;
        }
        
    } catch (error) {
        console.error('Route error:', error);
        showAlert('Error calculating route', 'danger');
        hideLoading();
    }
}

function createRoute(fromCoords, toCoords) {
    // Remove existing route
    if (routingControl) {
        map.removeControl(routingControl);
    }
    
    try {
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(fromCoords[0], fromCoords[1]),
                L.latLng(toCoords[0], toCoords[1])
            ],
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1',
                profile: 'driving'
            }),
            lineOptions: {
                styles: [{ color: '#4285F4', weight: 6, opacity: 0.8 }]
            },
            show: false,
            addWaypoints: false,
            routeWhileDragging: false,
            fitSelectedRoutes: true
        }).addTo(map);
        
        routingControl.on('routesfound', function(e) {
            var route = e.routes[0];
            var summary = route.summary;
            currentRoute = route;
            
            // Update summary
            document.getElementById('routeSummary').style.display = 'block';
            
            var distanceKm = (summary.totalDistance / 1000).toFixed(2);
            document.getElementById('routeDistance').innerHTML = '<i class="fas fa-road"></i> Distance: ' + distanceKm + ' km';
            
            var hours = Math.floor(summary.totalTime / 3600);
            var minutes = Math.floor((summary.totalTime % 3600) / 60);
            var timeStr = hours > 0 ? hours + 'h ' + minutes + 'm' : minutes + ' min';
            document.getElementById('routeTime').innerHTML = '<i class="fas fa-clock"></i> Time: ' + timeStr;
            
            // Check damages
            checkDamagesOnRoute(route);
            updateRouteDistances(route);
            hideLoading();
        });
        
        routingControl.on('routingerror', function() {
            showAlert('Could not calculate exact route, showing straight line', 'warning');
            
            // Draw straight line
            var latlngs = [fromCoords, toCoords];
            L.polyline(latlngs, { color: '#4285F4', weight: 4, dashArray: '10,10' }).addTo(map);
            
            var distance = getDistanceFromLatLonInMeters(fromCoords[0], fromCoords[1], toCoords[0], toCoords[1]) / 1000;
            document.getElementById('routeSummary').style.display = 'block';
            document.getElementById('routeDistance').innerHTML = '<i class="fas fa-road"></i> Distance: ' + distance.toFixed(2) + ' km (straight)';
            document.getElementById('routeTime').innerHTML = '<i class="fas fa-clock"></i> Time: ~' + Math.round(distance / 80 * 60) + ' min';
            
            hideLoading();
        });
        
    } catch (error) {
        console.error('Route creation error:', error);
        showAlert('Error creating route', 'danger');
        hideLoading();
    }
}

// ==================== DAMAGE DETECTION ====================
function checkDamagesOnRoute(route) {
    var totalDamages = 0;
    var highPriority = 0;
    
    markers.forEach(marker => {
        var damage = marker.damageData;
        var distance = getDistanceFromRoute(route, [damage.lat, damage.lng]);
        
        if (distance < 5000) { // Within 5km
            totalDamages++;
            if (damage.severity === 'high') highPriority++;
        }
    });
    
    var alertDiv = document.getElementById('damageAlert');
    var messageSpan = document.getElementById('damageMessage');
    var damageCount = document.getElementById('damageCount');
    
    if (totalDamages > 0) {
        if (highPriority > 0) {
            messageSpan.innerHTML = `‚ö†Ô∏è WARNING: ${highPriority} high-priority damages on your route!`;
            alertDiv.style.background = '#f8d7da';
            alertDiv.style.color = '#721c24';
        } else {
            messageSpan.innerHTML = `‚ÑπÔ∏è ${totalDamages} road damages detected along your route`;
            alertDiv.style.background = '#fff3cd';
            alertDiv.style.color = '#856404';
        }
        alertDiv.classList.add('show');
        damageCount.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Damages: ' + totalDamages + ' (High: ' + highPriority + ')';
    } else {
        alertDiv.classList.remove('show');
        damageCount.innerHTML = '<i class="fas fa-check-circle" style="color:#28a745;"></i> No damages on your route';
    }
}

function getDistanceFromRoute(route, point) {
    if (!route || !route.coordinates) return Infinity;
    
    var minDist = Infinity;
    route.coordinates.forEach(coord => {
        var dist = getDistanceFromLatLonInMeters(
            coord.lat, coord.lng,
            point[0], point[1]
        );
        if (dist < minDist) minDist = dist;
    });
    
    return minDist;
}

function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    var R = 6371000;
    var œÜ1 = lat1 * Math.PI/180;
    var œÜ2 = lat2 * Math.PI/180;
    var ŒîœÜ = (lat2 - lat1) * Math.PI/180;
    var ŒîŒª = (lon2 - lon1) * Math.PI/180;
    
    var a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
            Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    
    return R * c;
}

// ==================== TABLE FUNCTIONS ====================
function updateRouteDistances(route) {
    var distanceSpans = document.querySelectorAll('.route-distance');
    
    distanceSpans.forEach(span => {
        var lat = parseFloat(span.getAttribute('data-lat'));
        var lng = parseFloat(span.getAttribute('data-lng'));
        
        if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
            var distance = getDistanceFromRoute(route, [lat, lng]);
            
            if (distance < 100) {
                span.innerHTML = '<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> On route</span>';
            } else if (distance < 1000) {
                span.innerHTML = `<span style="color: #ffc107;"><i class="fas fa-road"></i> ${Math.round(distance)}m away</span>`;
            } else {
                span.innerHTML = `<span style="color: #6c757d;"><i class="fas fa-road"></i> ${(distance/1000).toFixed(1)}km away</span>`;
            }
        }
    });
}

// ==================== UTILITY FUNCTIONS ====================
function swapLocations() {
    var from = document.getElementById('from-location').value;
    var to = document.getElementById('to-location').value;
    document.getElementById('from-location').value = to;
    document.getElementById('to-location').value = from;
}

function setRoute(from, to) {
    document.getElementById('from-location').value = from;
    document.getElementById('to-location').value = to;
    calculateRoute();
}

function clearRoute() {
    if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
    }
    document.getElementById('routeSummary').style.display = 'none';
    document.getElementById('damageAlert').classList.remove('show');
    
    // Reset distance spans
    document.querySelectorAll('.route-distance').forEach(span => {
        span.innerHTML = 'Not in route';
    });
}

function flyToLocation(lat, lng) {
    if (!lat || !lng || lat === 0 || lng === 0) {
        showAlert('Invalid coordinates', 'warning');
        return;
    }
    map.flyTo([lat, lng], 15);
    
    // Find and open popup
    markers.forEach(marker => {
        if (marker.damageData.lat === lat && marker.damageData.lng === lng) {
            marker.openPopup();
        }
    });
}

function centerMap() {
    map.setView([13.0827, 80.2707], 8);
}

function updateStatistics() {
    var high = roadDamages.filter(d => d.severity === 'high').length;
    var medium = roadDamages.filter(d => d.severity === 'medium').length;
    var low = roadDamages.filter(d => d.severity === 'low').length;
    
    document.getElementById('statHigh').textContent = high;
    document.getElementById('statMedium').textContent = medium;
    document.getElementById('statLow').textContent = low;
    document.getElementById('statTotal').textContent = roadDamages.length;
    document.getElementById('activeIssuesCount').textContent = roadDamages.length;
}

function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showAlert(message, type) {
    var alertDiv = document.getElementById('damageAlert');
    var messageSpan = document.getElementById('damageMessage');
    
    messageSpan.innerHTML = message;
    alertDiv.className = 'damage-alert show';
    
    switch(type) {
        case 'danger':
            alertDiv.style.background = '#f8d7da';
            alertDiv.style.color = '#721c24';
            break;
        case 'success':
            alertDiv.style.background = '#d4edda';
            alertDiv.style.color = '#155724';
            break;
        default:
            alertDiv.style.background = '#fff3cd';
            alertDiv.style.color = '#856404';
    }
    
    setTimeout(() => {
        alertDiv.classList.remove('show');
    }, 5000);
}

// ==================== AUTOCOMPLETE ====================
function setupAutocomplete() {
    var fromInput = document.getElementById('from-location');
    var toInput = document.getElementById('to-location');
    
    fromInput.addEventListener('input', debounce(() => getSuggestions(fromInput), 300));
    toInput.addEventListener('input', debounce(() => getSuggestions(toInput), 300));
}

async function getSuggestions(input) {
    var query = input.value.trim();
    if (query.length < 3 || query.includes('üìç')) return;
    
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=in&limit=5`,
            { headers: { 'User-Agent': 'RoadMonitor/1.0' } }
        );
        const data = await response.json();
        
        // Simple alert for now - you can enhance with dropdown
        if (data && data.length > 0) {
            console.log('Suggestions:', data.map(d => d.display_name));
        }
    } catch (error) {
        console.log('Autocomplete error:', error);
    }
}

function debounce(func, wait) {
    var timeout;
    return function() {
        clearTimeout(timeout);
        timeout = setTimeout(func, wait);
    };
}

// Initialize autocomplete
setupAutocomplete();

// Make functions global
window.calculateRoute = calculateRoute;
window.useCurrentLocation = detectCurrentLocation;
window.clearRoute = clearRoute;
window.filterMarkers = filterMarkers;
window.centerMap = centerMap;
window.flyToLocation = flyToLocation;
window.detectCurrentLocation = detectCurrentLocation;
window.setFromToCurrent = setFromToCurrent;
window.setToToCurrent = setToToCurrent;
window.swapLocations = swapLocations;
window.setRoute = setRoute;
</script>
{% endblock %}